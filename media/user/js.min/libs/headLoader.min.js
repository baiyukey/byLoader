/**
 * headLoader用于加载、预加载及缓存网站资源，实现网站快速响应，优化服务器请求的目的。使用纯前端技术，基本上用"0成本"就能使普通的网站得到明显的加速效果。
 * @global : headLoader
 * @author: 宇哥 baiyukey@qq.com
 * @param {String} [this.dataDir] -资源路径
 * @param {Array} [this.dataCss] -CSS模块列表
 * @param {Array} [this.dataJs] -JS资源路径
 * @param {Number} [this.dataLifecycle=2] -缓存生成周期，单位小时，默认2
 * @param {Boolean} [this.dataActive=false] -是否自动切换线上与线下代码路径，默认否
 * @param {Function} [this.callback=null] -所有资源加载完成后的回调函数 (仅命令行模式可用)
 * @param {Boolean} [this.showLog=false] -是否显示加载统计(仅命令行模式可用)
 * @param {Number} [this.preload=0] -预加载开关(仅命令行模式可用) 1:预加载打开(不应用于当前页面)，0:预加载关闭（加载后立即应用于当前页面）。 默认0 。
 * @link : https://github.com/baiyukey/headLoader
 * @version : 2.0.0
 * @copyright : http://www.uielf.com
 */
function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function o(a,i){try{var c=t[a](i),r=c.value}catch(e){return void n(e)}if(!c.done)return Promise.resolve(r).then(function(e){o("next",e)},function(e){o("throw",e)});e(r)}("next")})}}let headLoader,LocalDB=function(e){let t=null,n=0;const o=function(){return new Promise((o,a)=>{1===n&&void 0!==o&&o("success");let i=indexedDB.open(e.database);return i.onerror=function(e){a(e)},i.onsuccess=function(e){t=i.result,n=1,o(e)},i.onupgradeneeded=function(n){t=n.target.result;let a=Object.keys(e.tables),i=function(n){if(!t.objectStoreNames.contains(a[n])){let c=t.createObjectStore(a[n],{keyPath:"key"});e.tables[a[n]].forEach(e=>c.createIndex(e,"key",{unique:!0})),n<a.length-1?i(n+1):o(t)}};i(0)}})},a=(i=_asyncToGenerator(function*(){if(0!==n)return t&&t.close(),console.log(`数据库${e.database}已关闭`),n=0}),function(){return i.apply(this,arguments)});var i;const c=(r=_asyncToGenerator(function*(){if(!t)return console.warn(`目前还没有数库${e.database}`);yield a(),indexedDB.deleteDatabase(e.database),t=null,console.log(`数据库${e.database}已删除`)}),function(){return r.apply(this,arguments)});var r;const l=(s=_asyncToGenerator(function*(n,o,a){return new Promise(function(i,c){let r=t.transaction(n,"readwrite").objectStore(n),l={key:o,value:a,version:e.getVersion()};new Promise(function(e,t){let n=r.index("key").get(o);n.onsuccess=(t=>{e(t.target.result?"put":"add")}),n.onerror=(()=>e("add"))}).then(function(e){let t=r[e](l);t.onsuccess=function(){i("success")},t.onerror=function(e){c(e)}})})}),function(e,t,n){return s.apply(this,arguments)});var s;const d=function(e,n){return new Promise((o,a)=>{let i=t.transaction(e,"readonly").objectStore(e).index("key").get(n);i.onsuccess=function(e){o(i.result)},i.onerror=function(e){a(e)}})};(function(){return!!(window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB)||(console.log("您的浏览器不支持indexedDB，请使用现代浏览器，例如chrome,firefox等."),!1)})&&(this.open=o,this.close=a,this.delete=c,this.setItem=l,this.getItem=d)};!function(e){let t=/^((192\.168|172\.([1][6-9]|[2]\d|3[01]))(\.([2][0-4]\d|[2][5][0-5]|[01]?\d?\d)){2}|10(\.([2][0-4]\d|[2][5][0-5]|[01]?\d?\d)){3})|(localhost)$/.test(e.location.hostname)?"":".min";headLoader=function(n){let o=n||{};this.dataDir=o.dataDir||"",this.dataCss=o.dataCss||[],this.dataJs=o.dataJs||[],this.dataLifecycle=o.dataLifecycle||l,this.dataActive=o.dataActive||r,this.callback=o.callback||null,this.multiLoad=o.multiLoad||".min"===t,this.showLog=o.showLog||!1,this.preload=void 0!==o.preload?o.preload:0;let a=this,i=e=>0===e.indexOf("http://")||0===e.indexOf("https://"),c=function(e){let n=new Date,o=e||2;return o=Math.min(24,o),""===t?""+n.getTime():""+(n.getMonth()+1)+n.getDate()+Math.ceil((n.getHours()+1)/o)},h=function(e){let t=[],n="";for(let o=0;o<e.length;o++)0!==(n=e[o].replace(/^(\s*)|(\s*)$/g,"")).length&&t.indexOf(n)<0&&t.push(n);return t},g=function(e,t){t.length>0&&t.forEach(function(t){e.setAttribute(t.split("=")[0],t.split("=")[1])})};void 0===e.headLoaderCache&&(e.headLoaderCache={});let m=function(e,t){C.setItem("data",B.encode(e),t).then(null)},J=function(e,n){return a.dataActive?`${a.dataDir}${n}${t}/${e.split("|")[0]}`.replace(`.${n}`,"")+t+"."+n:`${a.dataDir}${e.split("|")[0]}.${n}`},y=function(e,n){return((a.dataDir+n+t+"/"+e.split("|")[0]).replace("."+n,"")+t).replace(/\./g,"_")},U=function(e,t){if(i(e))return v(e),"function"==typeof t&&t(),!1;let n=J(e,"js")+"?v="+s,o=y(e,"js");C.getItem("data",B.encode(o)).then(e=>{!function(e){let a,i=e;null===i?(window.XMLHttpRequest?a=new XMLHttpRequest:window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP")),void 0!==a&&(a.open("GET",n),a.send(null),a.onreadystatechange=function(){4===Number(a.readyState)&&200===Number(a.status)&&(i=a.responseText,m(o,i=null===i?"":i),u++,"function"==typeof t&&t())})):"function"==typeof t&&t()}(e&&e.version===x.getVersion()?e.value:null)})},T=function(e,t){if(i(e))return L(e),"function"==typeof t&&t(),!1;let n=J(e,"css")+"?v="+s,o=y(e,"css");C.getItem("data",B.encode(o)).then(e=>{!function(e){let i,c=e;null===c?(window.XMLHttpRequest?i=new XMLHttpRequest:window.ActiveXObject&&(i=new ActiveXObject("Microsoft.XMLHTTP")),void 0!==i&&(i.open("GET",n),i.send(null),i.onreadystatechange=function(){4===Number(i.readyState)&&200===Number(i.status)&&(c=(c=(c=null===(c=i.responseText)?"":c).replace(/\[dataDir]/g,a.dataDir)).replace(/\[v]/g,d),m(o,c),u++,"function"==typeof t&&t())})):"function"==typeof t&&t()}(e&&e.version===x.getVersion()?e.value:null)})},w=function(e,n){if(""!==t)return Function(n)(),!1;let o=document.getElementsByTagName("HEAD").item(0),a=document.createElement("script");g(a,e.split("|").splice(1)),a.setAttribute("type","text/javascript"),a.setAttribute("data-name",e.split("|")[0].replace(".js","")+t),a.innerHTML=n,o.appendChild(a)},b=function(e,n){if(0===document.getElementsByTagName("HEAD").length)return!1;let o,i=document.getElementsByTagName("HEAD").item(0);if(a.multiLoad&&(o=document.getElementsByTagName("style").item(0)))return o.innerHTML+=n,!1;o=document.createElement("style"),g(o,e.split("|").splice(1)),o.setAttribute("type","text/css"),o.setAttribute("data-name",e.split("|")[0].replace(".css","")+t),o.innerHTML=n,i.appendChild(o)},v=function(e){if(0===document.getElementsByTagName("HEAD").length)return!1;let n=document.getElementsByTagName("HEAD").item(0),o=document.createElement("script");g(o,e.split("|").splice(1)),o.src=0===e.indexOf("http")?e.split("|")[0]:e.split("|")[0].replace(".js","")+t+".js?"+s,n.appendChild(o)},L=function(e){if(0===document.getElementsByTagName("HEAD").length)return!1;let n=document.getElementsByTagName("HEAD").item(0),o=document.createElement("link");g(o,e.split("|").splice(1)),o.type="text/css",o.rel="stylesheet",o.media="screen",o.href=0===e.indexOf("http")?e.split("|")[0]:e.split("|")[0].replace(".css","")+t+".css?"+s,n.appendChild(o)},E=(A=_asyncToGenerator(function*(e,n){return new Promise(function(o){let i,c={JS:w,CSS:b}[n.toUpperCase()],r={},l=[];e.forEach(function(e){r[e]=null;l.push(new Promise(function(o){i=(a.dataDir+n+t+"/"+e.replace(/(\.js)|(\.css)/g,"")+t).replace(/\./g,"_"),C.getItem("data",B.encode(i)).then(t=>{r[e]=t.value,o(!0)})}))}),Promise.all(l).then(function(){c(1===e.length?e[0]:n+"_"+s,Object.values(r).join("js"===n?";":" ")),o("success")})})}),function(e,t){return A.apply(this,arguments)});var A;let D=function(e,t,n){if(0===document.getElementsByTagName("HEAD").length)return!1;if(!e||0===e.length)return"function"==typeof n&&n.call(!1),!1;let o={JS:U,CSS:T}[t.toUpperCase()];(a.multiLoad?function(){if(!e||0===e.length)return"function"==typeof n&&n.call(!1),!1;let i=new Array(e.length).fill(0).map((t,n)=>new Promise(function(t){o(e[n],()=>t("success"))}));Promise.all(i).then(_asyncToGenerator(function*(){0!==e.length&&0===a.preload&&(yield E(e,t)),"function"==typeof n&&n.call(!1)}))}:function(){let i=0,c=function(){i>=e.length?"function"==typeof n&&n.call(!1):o(e[i],_asyncToGenerator(function*(){0===a.preload&&(yield E([e[i]],t)),i++,c()}))};c()})()},B=new function(){let e="";for(let t=48;t<=122;t++)t>=58&&t<=64||t>=91&&t<=96||(e+=String.fromCharCode(t));let t=(e=(e=e.replace(/[aeiouAEIOU01]/g,"")).slice(0,18)+"$-_+!*"+e.slice(18)).length,n=location.host.length,o=-1,a="",i="";this.encode=function(c){a=encodeURIComponent(c).replace(/\./g,"&dot"),i="",o=-1;for(let c=0;c<a.length;c++)o=e.indexOf(a.charAt(c)),i+=o<0?a.charAt(c):e.charAt((o+n)%t);return i}},x={database:"headLoaderDB",tables:{data:["key","value","version"]},getVersion:c},C=new LocalDB(x);this.run=function(){_asyncToGenerator(function*(){yield C.open(),a.dataCss=h(a.dataCss.join(",").replace(/_css/g,p).split(",")),a.dataJs=h(a.dataJs.join(",").replace(/_js/g,p).split(",")),s=c(l),d=c(24);let t=function(){a.showLog&&function(){let t=(new Date).getTime()-f;e.headLoaderHistory=void 0!==e.headLoaderHistory?e.headLoaderHistory:[],void 0!==e.showLogTimeout&&clearTimeout(e.showLogTimeout),e.showLogTimeout=setTimeout(()=>{u>0&&(e.headLoaderHistory=e.headLoaderHistory.concat(new Array(u-1).fill(0),t));let n=0,o=0;e.headLoaderHistory.length>0&&(n=e.headLoaderHistory.reduce((e,t)=>e+t),o=Math.ceil(n/e.headLoaderHistory.length)),console.log("当前页面使用headLoader"+(a.multiLoad?"并行":"串行")+"网络请求%c"+u+"个%cJS/CSS文件，程序用时%c"+t+"毫秒%c，累计网络请求%c"+e.headLoaderHistory.length+"个%cJS/CSS文件，单文件平均用时%c"+o+"毫秒","color:#1b8884","","color:#1b8884","","color:#1b8884","","color:#1b8884","")},3e3)}(),"function"==typeof a.callback&&a.callback.call(!1)};D(a.dataCss,"css",function(){D(a.dataJs,"js",t)})})()}};let n,o,a=document.getElementsByTagName("script"),i=[],c=[],r=!1,l=2,s="",d="",u=0,f=(new Date).getTime();for(let e=0;e<a.length;e++)if(a[e].hasAttribute("src")&&a[e].getAttribute("src").indexOf(atob("aGVhZExvYWRlci4="))>=0){n=a.item(e);break}if(!n)return console.log&&console.log("%c"+decodeURIComponent(atob("JUU5JTk0JTk5JUU4JUFGJUFGJUU2JThGJTkwJUU3JUE0JUJBJTNBJUU3JUE4JThCJUU1JUJBJThGJUU2JTlDJUFBJUU2JTg4JTkwJUU1JThBJTlGJUU2JTg5JUE3JUU4JUExJThDJTJDJUU2JThGJTkyJUU0JUJCJUI2JUU1JTkwJThEJUU3JUE3JUIwJUU0JUI4JUJBaGVhZExvYWRlci5qcyVFNiU4OCU5NiVFOCU4MCU4NWhlYWRMb2FkZXIubWluLmpzJUU2JUIzJUE4JUU2JTg0JThGJUU1JUE0JUE3JUU1JUIwJThGJUU1JTg2JTk5LiVFNSVBNiU4MiVFNiU5QyU4OSVFNyU5NiU5MSVFOSU5NyVBRSVFOCVBRiVCNyVFOCVBRSVCRiVFOSU5NyVBRSUzQWh0dHBzJTNBJTJGJTJGZ2l0aHViLmNvbSUyRmJhaXl1a2V5JTJGaGVhZExvYWRlcg==")),"color:#F00"),!1;let h=console.log&&".min"!==t,p=location.pathname.replace(".html","");""===location.pathname.replace(/.*\//,"").replace(".html","")&&(p+="index"),p=0===p.indexOf("/")?p.substr(1):p,n.hasAttribute("data-active")?r=["true",""].includes(n.getAttribute("data-active")):h&&console.log('%c友情提示:script标签未设置"data-active"属性,默认为false.',"color:#69F;"),n.hasAttribute("data-lifecycle")?l=Number(n.getAttribute("data-lifecycle")):h&&console.log(`%c友情提示:script标签未设置"data-lifecycle"属性,默认为${l}小时.`,"color:#69F;"),n.hasAttribute("data-dir")?o=n.getAttribute("data-dir"):h&&console.log('%c友情提示:script标签未设置"data-dir"属性.',"color:#69F;"),n.hasAttribute("data-css")?c=n.getAttribute("data-css").split(","):h&&console.log('%c友情提示:script标签未设置"data-css"属性',"color:#69F;"),n.hasAttribute("data-js")?i=n.getAttribute("data-js").split(","):h&&console.log('%c友情提示:script标签未设置"data-js"属性',"color:#69F;"),a.length>0&&""!==t&&a.item(0).remove();let g=new headLoader;o&&(g.dataDir=o),g.dataCss=c,g.dataJs=i,g.dataLifecycle=l,g.run()}(window.location.origin===window.top.location.origin?window.top:window);
