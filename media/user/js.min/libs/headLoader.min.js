/**
 * headLoader用于加载、预加载及缓存网站资源，实现网站快速响应，优化服务器请求的目的。使用纯前端技术，基本上用"0成本"就能使普通的网站得到明显的加速效果。
 * @global : headLoader
 * @link : https://github.com/baiyukey/headLoader
 * @version : 2.0.6
 */
function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function o(a,s){try{var i=t[a](s),r=i.value}catch(e){return void n(e)}if(!i.done)return Promise.resolve(r).then(function(e){o("next",e)},function(e){o("throw",e)});e(r)}("next")})}}let headLoader,localDB;!function(e){let t=new Function;if(e.XMLHttpRequest)t=e.XMLHttpRequest;else{if(!e.ActiveXObject)return alert("浏览器不支持XMLHttpRequest，请使用现代浏览器，例如chrome等。");t=e.ActiveXObject("Microsoft.XMLHTTP")}let n=/^((192\.168|172\.([1][6-9]|[2]\d|3[01]))(\.([2][0-4]\d|[2][5][0-5]|[01]?\d?\d)){2}|10(\.([2][0-4]\d|[2][5][0-5]|[01]?\d?\d)){3})|(localhost)$/.test(e.location.hostname)?"":".min";localDB=function(e){let t=null,n=0;const o=function(){return new Promise((o,a)=>{1===n&&void 0!==o&&o("success");let s=indexedDB.open(e.database);return s.onerror=function(e){a(e)},s.onsuccess=function(e){t=s.result,n=1,o(e)},s.onupgradeneeded=function(n){t=n.target.result;let a=Object.keys(e.tables);for(const n of a)if(!t.objectStoreNames.contains(n)){let o=t.createObjectStore(n,{keyPath:"key"});e.tables[n].forEach(e=>o.createIndex(e,"key",{unique:!0}))}n.target.transaction.oncomplete=(()=>o(t))}})},a=(s=_asyncToGenerator(function*(){return 0===n?n:(t&&t.close(),console.log(`数据库${e.database}已关闭`),n=0)}),function(){return s.apply(this,arguments)});var s;const i=(r=_asyncToGenerator(function*(){if(!t)return console.warn(`目前还没有数库${e.database}`);yield a(),indexedDB.deleteDatabase(e.database),t=null,console.log(`数据库${e.database}已删除`)}),function(){return r.apply(this,arguments)});var r;const c=(l=_asyncToGenerator(function*(n,o,a){return new Promise(function(s,i){let r=t.transaction(n,"readwrite").objectStore(n),c={key:o,value:a.value,etag:a.etag,version:e.getVersion()};new Promise(function(e,t){let n=r.index("key").get(o);n.onsuccess=(t=>{e(t.target.result?"put":"add")}),n.onerror=(()=>e("add"))}).then(function(e){let t=r[e](c);t.onsuccess=function(){s("success")},t.onerror=function(e){i(e)}})})}),function(e,t,n){return l.apply(this,arguments)});var l;const d=function(e,n){return new Promise((o,a)=>{let s=t.transaction(e,"readonly").objectStore(e).index("key").get(n);s.onsuccess=function(e){o(s.result)},s.onerror=function(e){a(e)}})};(function(){return!!(window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB)||(console&&console.log("您的浏览器不支持indexedDB，请使用现代浏览器，例如chrome,firefox等."),!1)})&&(this.open=o,this.close=a,this.delete=i,this.setItem=c,this.getItem=d)},headLoader=function(o){let a=o||{};this.dataDir=a.dataDir||"",this.dataCss=a.dataCss||[],this.dataJs=a.dataJs||[],this.dataFont=a.dataFont||[],this.dataLifecycle=a.dataLifecycle||d,this.dataActive=a.dataActive||l,this.callback=a.callback||null,this.multiLoad=a.multiLoad||".min"===n,this.showLog=a.showLog||!1,this.preload=void 0!==a.preload?a.preload:0;let s=this,i=function(e){let t=new Date,o=e||2;return o=Math.min(24,o),""===n?""+t.getTime():""+(t.getMonth()+1)+t.getDate()+Math.ceil((t.getHours()+1)/o)},r=function(e){let t=[],n="";for(let o=0;o<e.length;o++)0!==(n=e[o].replace(/^(\s*)|(\s*)$/g,"")).length&&t.indexOf(n)<0&&t.push(n);return t},c=function(e,t){t.length>0&&t.forEach(function(t){e.setAttribute(t.split("=")[0],t.split("=")[1])})};void 0===e.headLoaderCache&&(e.headLoaderCache={});let g=function(e,t){H.setItem("data",B.encode(e),t).then(null)},J=function(e,t,o){return s.dataActive&&["js","css"].includes(t)?`${s.dataDir}${t}${n}/${e.split("|")[0]}`.replace("."+(o||t),"")+n+"."+(o||t):`${s.dataDir}${t}/${e.split("|")[0]}.${o||t}`},y=function(e,n){return new Promise((a,s)=>{if(!e)return a(2);e.version!==F.getVersion()?""===e.etag?a(2):(o=n,new Promise((e,n)=>{let a=new t;a.open("HEAD",o,!0),a.send(),a.onreadystatechange=function(){4===Number(a.readyState)&&200===Number(a.status)&&e(a.getResponseHeader("etag")||a.getResponseHeader("last-modified")||"")},a.onerror=(e=>n(e))})).then(t=>{e.etag===t?a(1):a(2)}).catch(e=>s(e)):a(0)});var o},U=function(e,o){return new Promise(a=>{if((e=>0===e.indexOf("http://")||0===e.indexOf("https://"))(e))return"js"===o?v(e):"css"===o&&E(e),a("success");let i,r=J(e,o)+"?v="+u,c=function(e,t){return((s.dataDir+t+n+"/"+e.split("|")[0]).replace("."+t,"")+n).replace(/\./g,"_")}(e,o);H.getItem("data",B.encode(c)).then(e=>{y(i=e,r).then(e=>(function(e){if(0===e)a("success");else if(1===e)g(c,i),a("success");else if(2===e){let e=new t;e.open("GET",r,!0),e.send(),e.onreadystatechange=function(){if(4===Number(e.readyState)&&200===Number(e.status)){let t=e.responseText||"";"css"===o&&(t=t.replace(/\[v]/g,h)),g(c,{value:t,etag:e.getResponseHeader("etag")||e.getResponseHeader("last-modified")||""}),f++,a("success")}}}})(e)).catch(e=>console.error(e))})})},T=function(e){return new Promise((t=_asyncToGenerator(function*(t){let n=J(e,"fonts","woff")+"?v="+u;if("function"!=typeof FontFace)return new Promise(function(e){return e("success")});const o=new FontFace("elfRound","url("+n+")");yield o.load(),document.fonts.add(o),t("success")}),function(e){return t.apply(this,arguments)}));var t},w=function(e,t){if(""!==n)return Function(t)(),!1;let o=document.getElementsByTagName("HEAD").item(0),a=document.createElement("script");c(a,e.split("|").splice(1)),a.setAttribute("type","text/javascript"),a.setAttribute("data-name",e.split("|")[0].replace(".js","")+n),a.innerHTML=t,o.appendChild(a)},b=function(e,t){if(0===document.getElementsByTagName("HEAD").length)return!1;let o,a=document.getElementsByTagName("HEAD").item(0);if(s.multiLoad&&(o=document.getElementsByTagName("style").item(0)))return o.innerHTML+=t,!1;o=document.createElement("style"),c(o,e.split("|").splice(1)),o.setAttribute("type","text/css"),o.setAttribute("data-name",e.split("|")[0].replace(".css","")+n),o.innerHTML=t,a.appendChild(o)},v=function(e){if(0===document.getElementsByTagName("HEAD").length)return!1;let t=document.getElementsByTagName("HEAD").item(0),o=document.createElement("script");c(o,e.split("|").splice(1)),o.src=0===e.indexOf("http")?e.split("|")[0]:e.split("|")[0].replace(".js","")+n+".js?v="+u,t.appendChild(o)},E=function(e){if(0===document.getElementsByTagName("HEAD").length)return!1;let t=document.getElementsByTagName("HEAD").item(0),o=document.createElement("link");c(o,e.split("|").splice(1)),o.type="text/css",o.rel="stylesheet",o.media="screen",o.href=0===e.indexOf("http")?e.split("|")[0]:e.split("|")[0].replace(".css","")+n+".css?v="+u,t.appendChild(o)},L=(A=_asyncToGenerator(function*(e,t){return new Promise(function(o){let a,i={JS:w,CSS:b}[t.toUpperCase()];if(!i)return o("refuse this method.");let r={},c=[];e.forEach(function(e){r[e]=null;c.push(new Promise(function(o){a=(s.dataDir+t+n+"/"+e.replace(/(\.js)|(\.css)/g,"")+n).replace(/\./g,"_"),H.getItem("data",B.encode(a)).then(t=>{r[e]=t.value,o(!0)})}))}),Promise.all(c).then(function(){i(1===e.length?e[0]:t+"_"+u,Object.values(r).join("js"===t?";":" ")),o("success")})})}),function(e,t){return A.apply(this,arguments)});var A;let D=function(e,t){if(0===document.getElementsByTagName("HEAD").length)return!1;if(!e||0===e.length)return new Promise(e=>e("success"));let n={JS:U,CSS:U,FONT:T}[t.toUpperCase()],o=(a=_asyncToGenerator(function*(o){let a=0,i=(r=_asyncToGenerator(function*(){if(a>=e.length)return!0;yield n(e[a],t),0===s.preload&&(yield L([e[a]],t)),a++,yield i()}),function(){return r.apply(this,arguments)});var r;yield i(),o("success")}),function(e){return a.apply(this,arguments)});var a;return new Promise(s.multiLoad?function(o){e&&0!==e.length||o("success");let a=new Array(e.length).fill(0).map((o,a)=>new Promise((i=_asyncToGenerator(function*(o){yield n(e[a],t),o("success")}),function(e){return i.apply(this,arguments)})));var i;Promise.all(a).then(_asyncToGenerator(function*(){0!==e.length&&0===s.preload&&(yield L(e,t)),o("success")}))}:o)},B=new function(){let e="";for(let t=48;t<=122;t++)t>=58&&t<=64||t>=91&&t<=96||(e+=String.fromCharCode(t));let t=(e=(e=e.replace(/[aeiouAEIOU01]/g,"")).slice(0,18)+"$-_+!*"+e.slice(18)).length,n=location.host.length,o=-1,a="",s="";this.encode=function(i){a=encodeURIComponent(i).replace(/\./g,"&dot"),s="",o=-1;for(let i=0;i<a.length;i++)o=e.indexOf(a.charAt(i)),s+=o<0?a.charAt(i):e.charAt((o+n)%t);return s}},F={database:"headLoaderDB",tables:{data:["key","value","version"]},getVersion:i},H=new localDB(F);this.run=function(){_asyncToGenerator(function*(){yield H.open(),s.dataCss=r(s.dataCss.join(",").replace(/_css/g,m).split(",")),s.dataJs=r(s.dataJs.join(",").replace(/_js/g,m).split(",")),s.dataFont=r(s.dataFont.join(",").replace(/_js/g,m).split(",")),u=i(d),h=i(24);D(s.dataCss,"css"),D(s.dataFont,"font"),yield D(s.dataJs,"js"),s.showLog&&function(){let t=(new Date).getTime()-p;e.headLoaderHistory=void 0!==e.headLoaderHistory?e.headLoaderHistory:[],void 0!==e.showLogTimeout&&clearTimeout(e.showLogTimeout),e.showLogTimeout=setTimeout(()=>{f>0&&(e.headLoaderHistory=e.headLoaderHistory.concat(new Array(f-1).fill(0),t));let n=0,o=0;e.headLoaderHistory.length>0&&(n=e.headLoaderHistory.reduce((e,t)=>e+t),o=Math.ceil(n/e.headLoaderHistory.length)),console.log("当前页面使用headLoader"+(s.multiLoad?"并行":"串行")+"网络请求%c"+f+"个%cJS/CSS文件，程序用时%c"+t+"毫秒%c，累计网络请求%c"+e.headLoaderHistory.length+"个%cJS/CSS文件，单文件平均用时%c"+o+"毫秒","color:#1b8884","","color:#1b8884","","color:#1b8884","","color:#1b8884","")},3e3)}(),"function"==typeof s.callback&&s.callback.call(!1)})()}};let o,a,s=document.getElementsByTagName("script"),i=[],r=[],c=[],l=!1,d=2,u="",h="",f=0,p=(new Date).getTime();for(let e=0;e<s.length;e++)if(s[e].hasAttribute("src")&&s[e].getAttribute("src").indexOf(atob("aGVhZExvYWRlci4="))>=0){o=s.item(e);break}if(!o)return console.log&&console.log("%c"+decodeURIComponent(atob("JUU5JTk0JTk5JUU4JUFGJUFGJUU2JThGJTkwJUU3JUE0JUJBJTNBJUU3JUE4JThCJUU1JUJBJThGJUU2JTlDJUFBJUU2JTg4JTkwJUU1JThBJTlGJUU2JTg5JUE3JUU4JUExJThDJTJDJUU2JThGJTkyJUU0JUJCJUI2JUU1JTkwJThEJUU3JUE3JUIwJUU0JUI4JUJBaGVhZExvYWRlci5qcyVFNiU4OCU5NiVFOCU4MCU4NWhlYWRMb2FkZXIubWluLmpzJUU2JUIzJUE4JUU2JTg0JThGJUU1JUE0JUE3JUU1JUIwJThGJUU1JTg2JTk5LiVFNSVBNiU4MiVFNiU5QyU4OSVFNyU5NiU5MSVFOSU5NyVBRSVFOCVBRiVCNyVFOCVBRSVCRiVFOSU5NyVBRSUzQWh0dHBzJTNBJTJGJTJGZ2l0aHViLmNvbSUyRmJhaXl1a2V5JTJGaGVhZExvYWRlcg==")),"color:#F00"),!1;let g=console.log&&".min"!==n,m=location.pathname.replace(".html","");""===location.pathname.replace(/.*\//,"").replace(".html","")&&(m+="index"),m=0===m.indexOf("/")?m.substr(1):m,o.hasAttribute("data-active")?l=["true",""].includes(o.getAttribute("data-active")):g&&console.log('%c友情提示:script标签未设置"data-active"属性,默认为false.',"color:#69F;"),o.hasAttribute("data-lifecycle")?d=Number(o.getAttribute("data-lifecycle")):g&&console.log(`%c友情提示:script标签未设置"data-lifecycle"属性,默认为${d}小时.`,"color:#69F;"),o.hasAttribute("data-dir")?a=o.getAttribute("data-dir"):g&&console.log('%c友情提示:script标签未设置"data-dir"属性.',"color:#69F;"),o.hasAttribute("data-css")?r=o.getAttribute("data-css").split(","):g&&console.log('%c友情提示:script标签未设置"data-css"属性',"color:#69F;"),o.hasAttribute("data-js")?i=o.getAttribute("data-js").split(","):g&&console.log('%c友情提示:script标签未设置"data-js"属性',"color:#69F;"),o.hasAttribute("data-font")?c=o.getAttribute("data-font").split(","):g&&console.log('%c友情提示:script标签未设置"data-js"属性',"color:#69F;"),s.length>0&&""!==n&&s.item(0).remove();let J=new headLoader;a&&(J.dataDir=a),J.dataCss=r,J.dataJs=i,J.dataFont=c,J.dataLifecycle=d,J.run()}(window.location.origin===window.top.location.origin?window.top:window);
